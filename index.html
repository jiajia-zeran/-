<!DOCTYPE html><html lang="zh-CN"><head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover">
<title>森林小木屋 · 手绘版</title>
<link rel="manifest" href="manifest.json">
<link rel="icon" href="icon.png">
<meta name="theme-color" content="#0d1324">
<style>
:root{
  --night:.18;                 /* 夜色初始强度 */
  --vh:1vh;                    /* 安全 vh */
  --paper:#fff6e6; --ink:#3b3028;
  --sheetH:66vh; --blur:18px;
}
/* 基础 */
*{box-sizing:border-box} html,body{height:100%;margin:0;background:#0d1324;color:#eee9e2;
  font-family:-apple-system,BlinkMacSystemFont,"PingFang SC","HarmonyOS Sans","Segoe UI",Roboto,"Helvetica Neue",Arial,sans-serif}
.stage{
  position:relative;width:100vw;height:calc(var(--vh)*100);overflow:hidden;
  background:
    radial-gradient(70vmax 55vmax at 50% 58%, rgba(0,0,0,.22), rgba(0,0,0,.72) 60%, rgba(0,0,0,.9) 100%),
    url('background.jpg') center 8%/cover no-repeat;
  filter:brightness(calc(1 - var(--night)*.55));
}
.moonGlow{position:absolute;right:7vw;top:6vh;width:24vw;max-width:160px;aspect-ratio:1;border-radius:50%;
  box-shadow:0 0 45px 12px #ffeab466;pointer-events:none}
.welcome{
  position:absolute;left:6vw;top:calc(env(safe-area-inset-top,0px) + 10px);
  font-size:clamp(18px,6.2vw,36px);letter-spacing:2px;text-shadow:0 2px 10px rgba(0,0,0,.4);
  opacity:0;animation:fadeIn 1.2s ease forwards
}
@keyframes fadeIn{to{opacity:1}}
#soundBar{position:absolute;right:16px;top:calc(env(safe-area-inset-top,0px) + 8px);z-index:5}
#enableSound{border:0;border-radius:12px;padding:10px 12px;background:#ffd58c;color:#3b2b1d;box-shadow:0 10px 26px rgba(0,0,0,.25)}

/* 便签（按新图右上） */
.note{
  position:absolute; left:17%; top:35%;
  width:min(76vw,560px); max-width:600px; min-height:92px; padding:12px 14px;
  background:var(--paper); color:var(--ink); border-radius:12px; box-shadow:0 14px 26px rgba(0,0,0,.35);
  transform:rotate(-3deg); font-size:clamp(12px,3.8vw,16px); line-height:1.65
}
.note::before{content:"便签";position:absolute;top:-10px;left:12px;background:#efc76d;color:#3e2d20;padding:2px 8px;border-radius:4px;font-size:12px}

/* —— 热区（全部重标） —— */
.hotspot{position:absolute;background:transparent;border:0;margin:0;padding:0;cursor:pointer}
.hotspot:focus-visible{outline:2px dashed #ffd58c;border-radius:8px}

/* 窗户（书+灯区域，略偏右） */
#hs-window{left:33%; top:57.5%; width:36%; height:21%}

/* 灯泡（窗户中的圆灯） */
#hs-lamp{left:46.2%; top:54.8%; width:12%; height:9.8%; border-radius:50%}

/* 书架小牌（更靠最右） */
#hs-shelf{right:6.5%; top:46.6%; width:25.5%; height:7.6%}

/* 日记纸条（猫旁纸张） */
#hs-diaries{left:18.5%; bottom:24.8%; width:34.5%; height:16.5%}

/* 杯子（右下小桌） */
#hs-cup{right:13.5%; bottom:18%; width:17.5%; height:13%}

/* 蒸汽文字（跟随杯子定位） */
.steamText{position:absolute;left:50%;top:50%;transform:translate(-50%,-100%);
  width:56vw;max-width:280px;text-align:center;font-size:clamp(12px,3.6vw,14px);color:#ffffffde;
  filter:blur(.2px);opacity:0;pointer-events:none}

/* 柔光 */
#glow{position:absolute;inset:0;pointer-events:none;mix-blend-mode:screen;background:
  radial-gradient(42vw 28vw at 46% 54%, rgba(255,235,200,.45), transparent 60%),
  radial-gradient(26vw 18vw at 58% 75%, rgba(255,220,170,.38), transparent 60%)}

/* 抽屉 */
.sheet{position:fixed;left:0;right:0;bottom:-2px;height:var(--sheetH);z-index:20;
  backdrop-filter:saturate(1.2) blur(var(--blur));-webkit-backdrop-filter:saturate(1.2) blur(var(--blur));
  background:linear-gradient(180deg,rgba(255,248,235,.75),rgba(255,243,225,.78));
  border-radius:16px 16px 0 0;box-shadow:0 -12px 40px rgba(0,0,0,.45);
  transform:translateY(110%);transition:.35s ease;display:flex;flex-direction:column;color:#2b241f}
.sheet.show{transform:translateY(0)}
.sheet header{padding:14px 16px;background:rgba(240,223,194,.85);display:flex;justify-content:space-between;align-items:center;border-top-left-radius:16px;border-top-right-radius:16px}
.sheet .body{padding:12px 16px;overflow:auto}
.sheet .actions{padding:12px 16px;display:flex;gap:10px;background:rgba(245,234,214,.85)}
.sheet button{border:0;border-radius:10px;padding:10px 12px;background:#2f3640;color:#fff}
textarea{width:100%;min-height:28vh;border:1px solid #d0c5b6;border-radius:10px;padding:10px;background:#fff}
.toast{position:fixed;left:50%;bottom:18vh;transform:translateX(-50%);background:rgba(255,240,210,.95);color:#2b241f;border-radius:12px;padding:12px 14px;box-shadow:0 12px 30px rgba(0,0,0,.3);display:none;z-index:25}
.toast.show{display:block;animation:fadeToast 2.2s ease}
@keyframes fadeToast{0%{opacity:0;transform:translate(-50%,6px)}15%{opacity:1;transform:translate(-50%,0)}85%{opacity:1}100%{opacity:0}}
@keyframes riseWords{0%{opacity:0;transform:translate(-50%,6px)}20%{opacity:.95}100%{opacity:0;transform:translate(-50%,-12px)}}

/* 调试：更醒目的边框+标签 */
body.debug .hotspot{outline:3px solid #70e6ffcc;background:rgba(112,230,255,.10)}
body.debug .hotspot::after{
  content:attr(title); position:absolute; left:4px; top:4px;
  font-size:12px; color:#0b3550; background:#c8f1ff; padding:2px 6px; border-radius:6px;
}

@media (max-width:480px){ :root{--sheetH:68vh} }
</style>
</head>
<body>
<div class="stage" id="stage">
  <div class="moonGlow"></div>
  <div class="welcome" id="welcome">你回来了 · 我在这儿</div>
  <div id="soundBar"><button id="enableSound">开启音乐</button></div>

  <div class="note" id="note">炉火还在跳，杯子也温着。</div>

  <!-- 热区按钮 -->
  <button id="hs-shelf"  class="hotspot" title="书架"></button>
  <button id="hs-cup"    class="hotspot" title="热咖啡"></button>
  <button id="hs-window" class="hotspot" title="窗户（长按）"></button>
  <button id="hs-diaries"class="hotspot" title="日记本"></button>
  <button id="hs-lamp"   class="hotspot" title="点灯"></button>

  <div class="steamText" id="steamText"></div>
  <div id="glow"></div>
</div>

<!-- 留言抽屉 -->
<div class="sheet" id="sheet">
  <header><strong id="sheetTitle">写留言</strong><button id="closeSheet">关闭</button></header>
  <div class="body">
    <div id="writeBox"><textarea id="msg" placeholder="写点想说的话吧…"></textarea></div>
    <div id="historyBox" style="display:none"></div>
  </div>
  <div class="actions">
    <button id="saveBtn">保存到日记本</button>
    <button id="historyBtn">查看回顾</button>
  </div>
</div>

<div class="toast" id="toast"></div>

<script>
(function(){
/* 安全 vh */
function setVH(){document.documentElement.style.setProperty('--vh',(window.innerHeight*0.01)+'px')}
addEventListener('resize',setVH,{passive:true}); setVH();

/* 工具 */
const $=s=>document.querySelector(s);
const shelf=$("#hs-shelf"), cup=$("#hs-cup"), steamText=$("#steamText"),
      windowBtn=$("#hs-window"), lampBtn=$("#hs-lamp"), diaries=$("#hs-diaries"),
      sheet=$("#sheet"), closeSheet=$("#closeSheet"), saveBtn=$("#saveBtn"),
      historyBtn=$("#historyBtn"), sheetTitle=$("#sheetTitle"), toast=$("#toast"),
      enableSound=$("#enableSound");

/* 夜色渐深 */
let night=.18; setInterval(()=>{ night=Math.min(1, night+.02);
  document.documentElement.style.setProperty('--night', night.toFixed(3));
}, 20000);

/* 蒸汽文字 */
const STEAM=["别怕，慢慢来。","今天也要被温柔对待。","喝口热的，再继续。","你值得被好好拥抱。"];
let si=0;
function nextSteam(){ steamText.textContent=STEAM[si%STEAM.length]; si++;
  steamText.style.opacity=1; steamText.style.animation='riseWords 3.6s ease';
  setTimeout(()=>{steamText.style.animation=''; steamText.style.opacity=0;},3600);
}
cup.addEventListener('click', nextSteam);
/* 跟随杯子定位 */
function placeSteamNearCup(){
  const r=cup.getBoundingClientRect();
  steamText.style.left=((r.left+r.right)/2)+'px';
  steamText.style.top =(r.top - 10)+'px';
  steamText.style.transform='translate(-50%,-100%)';
}
addEventListener('resize', placeSteamNearCup);
addEventListener('orientationchange', placeSteamNearCup);
setTimeout(placeSteamNearCup, 30);

/* 书架彩蛋 */
const SHELF_HINT=["书页之间夹着一张旧车票：终点写着“拥抱”。","把喜欢塞进第七本书里，等你发现。","愿你被这个世界轻轻接住。"];
function toastIt(t){ toast.textContent=t; toast.classList.add('show'); setTimeout(()=>toast.classList.remove('show'),2000) }
shelf.addEventListener('click',()=>toastIt(SHELF_HINT[Math.floor(Math.random()*SHELF_HINT.length)]));

/* 窗户长按 */
const WHISPER=["我在这儿，抬眼就能看见。","闭上眼，我数到三，你会更轻松。","把心交给我保管一会儿。","你回来了，欢迎回家。"];
let hold=null; function startHold(){ hold=setTimeout(()=>{ toastIt(WHISPER[Math.floor(Math.random()*WHISPER.length)]); chime(); }, 650) }
function endHold(){ clearTimeout(hold); hold=null }
['mousedown','touchstart'].forEach(e=>windowBtn.addEventListener(e,startHold));
['mouseup','mouseleave','touchend','touchcancel'].forEach(e=>windowBtn.addEventListener(e,endHold));

/* 日记本 */
const KEY="cabin_diary_v4";
const getH=()=>{try{return JSON.parse(localStorage.getItem(KEY))||[]}catch(e){return[]}};
const saveH=t=>{const a=getH();a.unshift({text:t,ts:Date.now()});localStorage.setItem(KEY,JSON.stringify(a))};
const fmt=t=>{const d=new Date(t),p=n=>String(n).padStart(2,'0');return `${d.getFullYear()}-${p(d.getMonth()+1)}-${p(d.getDate())} ${p(d.getHours())}:${p(d.getMinutes())}`};
function openWrite(){sheet.classList.add('show');sheetTitle.textContent="写留言";$("#writeBox").style.display="";$("#historyBox").style.display="none";$("#msg").value="";setTimeout(()=>$("#msg").focus(),30)}
function openHistory(){sheet.classList.add('show');sheetTitle.textContent="留言回顾";$("#writeBox").style.display="none";
  const list=getH(); const html=list.length?list.map(x=>`<div style="padding:10px 0;border-bottom:1px dashed #d0c5b6"><div style="font-size:14px;color:#7a6b5c">${fmt(x.ts)}</div><div style="margin-top:6px;white-space:pre-wrap;font-size:16px">${x.text}</div></div>`).join(""):'<div style="color:#7a6b5c">还没有留言。</div>';
  $("#historyBox").innerHTML='<div style="padding:6px 0;font-size:14px;color:#7a6b5c">以下是你留在小屋的痕迹</div>'+html; $("#historyBox").style.display=""}
diaries.addEventListener('click',openWrite);
historyBtn.addEventListener('click',openHistory);
saveBtn.addEventListener('click',()=>{const t=($("#msg").value||"").trim(); if(!t) return; saveH(t); sheet.classList.remove('show'); toastIt("收到了，我替你把心事放进日记里。")});
closeSheet.addEventListener('click',()=>sheet.classList.remove('show'));

/* WebAudio 轻音乐 */
let ctx,master; function ensureAudio(){ if(ctx) return; ctx=new (window.AudioContext||window.webkitAudioContext)(); master=ctx.createGain(); master.gain.value=.55; master.connect(ctx.destination); startAmbient(); }
enableSound.addEventListener('click', async ()=>{ ensureAudio(); try{ await ctx.resume(); enableSound.parentElement.style.display='none' }catch(e){} });
function chord(f){const g=ctx.createGain();g.gain.value=0;g.connect(master);const now=ctx.currentTime;
  const osc=f.map(x=>{const o=ctx.createOscillator();o.type='sine';o.frequency.value=x;const l=ctx.createOscillator(),lg=ctx.createGain();l.frequency.value=.08;lg.gain.value=2;l.connect(lg);lg.connect(o.frequency);o.connect(g);o.start();l.start();return o});
  g.gain.linearRampToValueAtTime(0,now);g.gain.linearRampToValueAtTime(.18,now+1);g.gain.linearRampToValueAtTime(.18,now+6.8);g.gain.linearRampToValueAtTime(0,now+8.2);
  setTimeout(()=>osc.forEach(o=>o.stop()),8300)}
function startAmbient(){const seq=[[440,554.37,659.25],[369.99,440,554.37],[293.66,369.99,440],[329.63,415.3,493.88]];let k=0;chord(seq[k%seq.length]);setInterval(()=>{k++;chord(seq[k%seq.length])},8200)}
function chime(){if(!ctx)ensureAudio();const g=ctx.createGain();g.gain.value=0;g.connect(master);const o=ctx.createOscillator();o.type='sine';o.frequency.value=660;o.connect(g);const n=ctx.currentTime;g.gain.linearRampToValueAtTime(0,n);g.gain.linearRampToValueAtTime(.5,n+.02);g.gain.exponentialRampToValueAtTime(.001,n+1.25);o.frequency.exponentialRampToValueAtTime(440,n+1.25);o.start();o.stop(n+1.28)}

/* 调试开关：长按 2 秒 or URL #debug */
let dbgTimer=null, dbgOn=false;
document.addEventListener('touchstart', ()=>{ dbgTimer=setTimeout(()=>{ dbgOn=!dbgOn; document.body.classList.toggle('debug', dbgOn); toastIt(dbgOn?'显示热区':'隐藏热区'); }, 2000) }, {passive:true});
document.addEventListener('touchend', ()=>clearTimeout(dbgTimer), {passive:true});
if (location.hash.includes('debug')) { document.body.classList.add('debug'); setTimeout(()=>toastIt('调试模式已开启'), 200); }

})();
</script>
</body></html>
